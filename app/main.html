<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.6/material.amber-indigo.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic&amp;subset=latin,cyrillic,cyrillic-ext" rel="stylesheet" type="text/css">
    <script src="https://storage.googleapis.com/code.getmdl.io/1.0.6/material.min.js"></script>
    <style type="text/css">.ng-hide:not(.ng-hide-animate) {
  display: none !important;
}
html,
body,
.layout {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  overflow: hidden;
}
body {
  background-size: 20px 20px;
}
/*independent blocks*/
.categories {
  display: flex;
  flex-flow: row wrap;
  justify-content: center;
  align-items: center;
  align-content: center;
}
.categories__category {
  flex: 0 0 150px;
  width: 150px;
  margin: 1rem 1rem;
}
.categories__category >.mdl-card__supporting-text {
  padding: 0 16px;
}
.categories__category >.mdl-card__title {
  height: 140px;
  background-position: 50% 0%;
  background-repeat: no-repeat;
}
.categories__category .mdl-card__title-text {
  background-color: rgba(194,236,32,0.58);
  border-radius: 5px;
  padding-left: 0.4em;
  padding-right: 0.4em;
  white-space: nowrap;
  font-size: 15px;
}
.categories__category .mdl-button {
  min-width: 4.2em;
  padding: 0 0.4em;
  margin-left: 0.4em;
}
.category__spend {
  float: right;
}
.category__clear {
  float: right;
}
.category__current {
  float: right;
}
.prop {
  font-family: 'Roboto';
  display: inline;
  white-space: nowrap;
  line-height: 1.6;
}
.prop__name {
  font-weight: 300;
  padding: 0 0.8em 0 0.4em;
  vertical-align: middle;
  border-radius: 5px;
  background-color: #d7e0e0;
  margin-right: -0.4em;
}
.prop__value {
  background-color: #5a5a5a;
  vertical-align: middle;
  color: #fff;
  border-radius: 5px;
  display: inline;
  box-sizing: border-box;
  font-weight: 500;
  text-align: center;
  padding: 0.1em 0.3em;
}
.prop__value.prop__value_big-green,
.prop__value.prop__value_big-red {
  padding: 0.2em 0.4em;
  border-radius: 10px;
}
.prop__value.prop__value_green,
.prop__value.prop__value_big-green {
  background-color: #5fa347;
}
.prop__value.prop__value_red,
.prop__value.prop__value_big-red {
  background-color: #ec2b58;
}
.drawer {
  position: fixed;
  padding: 0.4rem 1rem 0.8rem 1rem;
  background-color: #fff;
  box-sizing: border-box;
  z-index: 2;
  top: 0;
  left: 0;
  width: 100%;
  display: flex;
  flex-flow: row wrap;
  align-items: flex-end;
  align-content: flex-start;
  transition: top 0.7s;
}
.drawer__props {
  flex: 1 1 auto;
  display: flex;
  flex-flow: column nowrap;
  justify-content: flex-start;
  align-items: flex-start;
  align-content: flex-start;
}
.drawer__props >.prop {
  flex: 0 0 auto;
  margin-top: 0.2em;
}
.drawer__controls {
  flex: 1 1 auto;
  text-align: center;
  white-space: nowrap;
}
.shutter {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left: 0;
  text-align: center;
  background-color: #000;
  z-index: 9;
  box-sizing: border-box;
}
.shutter:before {
  display: inline-block;
  content: "";
  line-height: 100%;
  height: 100%;
  vertical-align: middle;
}
.shutter.shutter_modal {
  background-color: rgba(0,0,0,0.64);
  padding: 1em;
}
.shutter.shutter_modal:before {
  display: none;
}
.shutter__message {
  display: inline-block;
  vertical-align: middle;
}
.modal {
  box-sizing: border-box;
  min-width: 300px;
  max-width: 100%;
  margin: 0 auto;
  background-color: #e6e4e0;
  padding-bottom: 0.8em;
  max-height: 100%;
  overflow: hidden;
  display: flex;
  flex-flow: column nowrap;
  justify-content: flex-start;
  align-items: stretch;
  align-content: stretch;
}
.modal__title {
  flex: 0 0 29px;
  padding: 0.2em;
  background-color: #3f51b5;
  color: #fff;
  font: normal normal 300 16pt/1 "Roboto";
  box-sizing: border-box;
}
.modal__body {
  flex: 1 1 auto;
  margin: 0.8em 0;
  overflow-x: hidden;
  overflow-y: auto;
}
.modal__controls {
  flex: 0 0 36px;
  box-sizing: border-box;
}
.contractors {
  margin-left: -0.4em;
}
.contractors__contractor {
  background-color: #fff;
  border: none;
  width: 47%;
  box-sizing: border-box;
  white-space: nowrap;
  overflow: hidden;
  margin: 0 0 0.4em 0.4em;
  text-align: left;
  padding: 0.4em;
  min-width: 285px;
  max-width: 370px;
  font: normal normal 300 16pt/1 "Roboto";
  border-radius: 4px;
}
.contractor__image {
  width: 50%;
  padding-bottom: 30%;
  background-repeat: no-repeat;
  background-size: contain;
  display: inline-block;
  max-width: 120px;
  vertical-align: top;
}
.contractor__content {
  display: inline-block;
  vertical-align: top;
}
.contractor__title {
  background-color: rgba(194,236,32,0.58);
  border-radius: 5px;
  padding-left: 0.4em;
  padding-right: 0.4em;
  white-space: nowrap;
}
.contractor__data {
  margin-top: 1em;
  font: normal normal 600 20pt/1 "Roboto";
}
.message__text {
  color: #fff;
}
.message__text.message__text_error {
  color: #f00;
}
.message__text.message__text_error:before {
  content: "err:";
  display: inline;
  background-color: #f00;
  color: #000;
  border-radius: 4px;
  padding: 0.2em 0.4em;
  margin-right: 0.4em;
}
.message__controls {
  display: block;
  margin-top: 1em;
}
/*layout and elements */
.full-width,
.layout__categories,
.layout__fields,
.layout__additionals {
  width: 100%;
  opacity: 1;
  position: relative;
}
.layout {
  overflow-y: auto;
}
.layout__categories.ng-enter {
  opacity: 1;
  animation: layout-enter 0.3s, layout-enter1 0.5s;
}
.layout__categories.ng-leave {
  opacity: 0;
  animation: layout-leave 0.3s, layout-leave1 0.5s;
}
.layout__fields.ng-enter {
  opacity: 1;
  animation: layout-enter 0.3s, layout-enter1 0.5s;
}
.layout__fields.ng-leave {
  opacity: 0;
  animation: layout-leave 0.3s, layout-leave1 0.5s;
}
.layout__additionals.ng-enter {
  opacity: 1;
  animation: layout-enter 0.3s, layout-enter1 0.5s;
}
.layout__additionals.ng-leave {
  opacity: 0;
  animation: layout-leave 0.3s, layout-leave1 0.5s;
}
@-moz-keyframes layout-enter {
  0% {
    opacity: 0;
  }
  100% {
    opacity: 1;
  }
}
@-webkit-keyframes layout-enter {
  0% {
    opacity: 0;
  }
  100% {
    opacity: 1;
  }
}
@-o-keyframes layout-enter {
  0% {
    opacity: 0;
  }
  100% {
    opacity: 1;
  }
}
@keyframes layout-enter {
  0% {
    opacity: 0;
  }
  100% {
    opacity: 1;
  }
}
@-moz-keyframes layout-leave {
  0% {
    opacity: 1;
  }
  100% {
    opacity: 0;
  }
}
@-webkit-keyframes layout-leave {
  0% {
    opacity: 1;
  }
  100% {
    opacity: 0;
  }
}
@-o-keyframes layout-leave {
  0% {
    opacity: 1;
  }
  100% {
    opacity: 0;
  }
}
@keyframes layout-leave {
  0% {
    opacity: 1;
  }
  100% {
    opacity: 0;
  }
}
@-moz-keyframes layout-enter1 {
  0% {
    height: 0%;
  }
  100% {
    height: 100%;
  }
}
@-webkit-keyframes layout-enter1 {
  0% {
    height: 0%;
  }
  100% {
    height: 100%;
  }
}
@-o-keyframes layout-enter1 {
  0% {
    height: 0%;
  }
  100% {
    height: 100%;
  }
}
@keyframes layout-enter1 {
  0% {
    height: 0%;
  }
  100% {
    height: 100%;
  }
}
@-moz-keyframes layout-leave1 {
  0% {
    height: 100%;
  }
  100% {
    height: 0%;
  }
}
@-webkit-keyframes layout-leave1 {
  0% {
    height: 100%;
  }
  100% {
    height: 0%;
  }
}
@-o-keyframes layout-leave1 {
  0% {
    height: 100%;
  }
  100% {
    height: 0%;
  }
}
@keyframes layout-leave1 {
  0% {
    height: 100%;
  }
  100% {
    height: 0%;
  }
}

    </style>
  </head>
  <body ng-app="oAccount">
    <script type="text/ng-template" id="modal.jade">
      <div ng-show="!(shutter.loading||shutter.show)" class="ng-hide shutter shutter_modal">
        <div class="mdl-shadow--6dp modal">
          <div class="modal__title">Select a contractor
          </div>
          <div class="body modal__body">
            <div class="contractors">
              <button o-mdl ng-repeat="contractor in contractors track by contractor.id" ng-click="$close(contractor)" class="contractor contractors__contractor mdl-shadow--2dp">
                <div ng-style="{'background-image':'url({{contractor.image}})'}" class="contractor__image">
                </div>
                <div class="contractor__content">
                  <div ng-bind="contractor.name" class="contractor__title">
                  </div>
                  <div ng-bind="contractor.current*contractor.type" class="contractor__data">
                  </div>
                </div>
              </button>
            </div>
          </div>
          <div class="controls modal__controls">
            <button ng-click="$close()" class="controls__control mdl-button mdl-button--colored mdl-button--raised mdl-js-button mdl-js-ripple-effect">BACK 
            </button>
          </div>
        </div>
      </div>
    </script>
    <div ng-controller="oOutcomes as ctl" class="layout">
      <div o-drawer ng-show="drawer.show" class="drawer layout__drawer mdl-shadow--2dp ng-hide">
        <div ng-click="showDateInput=true" class="drawer__props">
          <div ng-show="overallOutcome>0" class="ng-hide prop"><span class="prop__name">Итог</span><span ng-bind="overallOutcome" class="prop__value prop__value_big-red"></span>
          </div>
          <div ng-show="overallIncome>0" class="ng-hide prop"><span class="prop__name">Итог</span><span ng-bind="overallIncome" class="prop__value prop__value_big-green"></span>
          </div>
          <div ng-show="showDateInput" class="ng-hide prop">
            <input type="date" ng-model="operationDate">
          </div>
        </div>
        <div class="drawer__controls">
          <button o-mdl ng-click="ctl.checkOut()" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect">CHECKOUT</button>
          <button o-mdl ng-click="ctl.clearCategoryAmount()" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent mdl-js-ripple-effect">CLEAR</button>
        </div>
      </div>
      <div ng-if="state.stage=='categories'" class="categories layout__categories">
        <div o-mdl ng-repeat="category in categories track by category.id" ng-hide="category.type==1 && overallOutcome>0 || category.type==-1 && overallIncome>0" class="categories__category category mdl-card mdl-shadow--2dp">
          <div ng-style="{'background-image':'url({{category.image}})'}" class="mdl-card__title">
            <h1 ng-bind="category.name" class="mdl-card__title-text"></h1>
          </div>
          <div class="mdl-card__supporting-text">
            <div ng-show="category.current!=0" class="category__prop ng-hide prop"><span class="prop__name">Месяц</span><span ng-bind="category.type*category.current" class="prop__value"></span>
            </div>
            <div ng-show="category.amount>0" class="category__prop ng-hide prop"><span class="prop__name">Расчет</span><span ng-bind="category.amount" ng-class="{'prop__value_green':category.type==1,'prop__value_red':category.type==-1}" class="prop__value"></span>
            </div>
          </div>
          <div class="mdl-card__actions">
            <div o-mdl class="mdl-textfield mdl-js-textfield">
              <input type="number" id="category.id" ng-model="amount" class="mdl-textfield__input">
              <label for="category.id" class="mdl-textfield__label">Price</label>
            </div>
            <button o-mdl ng-show="category.amount>0" ng-click="ctl.clearCategoryAmount(category);amount=''" class="category__clear mdl-button mdl-button--accent mdl-button--raised mdl-js-button mdl-js-ripple-effect ng-hide">CLEAR
            </button>
            <button o-mdl ng-click="ctl.spendOnCategory(category,amount);amount=''" class="category__spend mdl-button mdl-button--colored mdl-button--raised mdl-js-button mdl-js-ripple-effect">ADD
            </button>
          </div>
        </div>
      </div>
    </div>
    <o-view></o-view>
    <div ng-hide="!(shutter.loading||shutter.show)" class="shutter">
      <div class="message shutter__message">
        <div ng-class="{'is-active':shutter.loading}" class="mdl-js-spinner mdl-spinner message__spinner">
        </div>
        <div ng-bind="shutter.message.text" ng-class="{'message__text_error':shutter.message.isError}" class="message__text">
        </div>
        <div ng-show="!shutter.loading" class="message__controls ng-hide">
          <button ng-click="shutter.show=false" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect">OK</button>
        </div>
      </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.2/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.2/angular-animate.js"></script>
    <script type="text/javascript">/*global angular google componentHandler $*/
angular.module("oAccount",["ngAnimate"]).run(['$rootScope',function($root){
  $root.shutter={loading:true,show:false,message:{isError:false,text:''}};
  $root.drawer={show:false};
}]).directive("oMdl",function(){
  return {
    priority: 0,
    restrict: 'A',
    scope: false,
    link: function oMdlPostLink(scope, iElement, iAttrs) {
      componentHandler.upgradeElement(iElement.get(0));
    }
  }
}).factory("oModalSvc", ["$rootScope","$q","$templateRequest","$compile",function oModalSvc($root,$q,$tpl,$compile){
  oModalPromise.view=null;
  var q=null;
  function oModalPromise(options){
    if (oModalPromise.view==null) {
      throw new Error('oModalSvc: No view directive registered');
    }
    if (q!=null) throw new Error('oModalSvc: Already active');
    if (options.template==null) throw new Error("oModalSvc: template required");
    var template=null;
    var scope=$root.$new(true);
    $tpl(options.template).then(function(tpl){template=angular.element(tpl);
      oModalPromise.view.append(template);
      $compile(template)(scope);
    },function(data){
      console.log(data);
    });
    if (options.scope!=null){
      angular.extend(scope,options.scope);
    }
    scope.$close=function(message){
      oModalPromise.view.empty();
      scope.$destroy();
      q.resolve(message);
      q=null;
    };
    q=$q.defer();
    return q.promise;
  }
  return oModalPromise;
}]).directive("oView",['oModalSvc',function(oModalSvc){
  return {
    priority: 0,
    restrict: 'EA',
    scope: false,
    link: function oViewPostLink(scope, iElement, iAttrs) {
      oModalSvc.view=iElement;
    }
  };
}])
.directive("oDrawer",function(){
  var deferScrollRecalc=null;
  return {
    priority: 0,
    restrict: 'A',
    scope: false,
    link: function oDrawerPostLink(scope, iElement, iAttrs) {
      iElement.parent().on("scroll.oDrawer",function (e){
        if (deferScrollRecalc!=null){
          clearTimeout(deferScrollRecalc);
        }
        deferScrollRecalc=setTimeout(function(){
          deferScrollRecalc=null;
          if ($(e.target).scrollTop()>0){
            var prev=parseInt(iElement.css("height"));
            iElement.css({top:'-'+(prev-8)+'px'});
          }else{
            iElement.css({top:""});
          }
        },400);
      });
    }
  }
}).controller("oOutcomes",["$scope",'$rootScope',"oModalSvc",function($scope,$root,oModalSvc){

  /*----------*/
  function recalcOverallAmount(){
    $scope.overallIncome=0;
    $scope.overallOutcome=0;
    $scope.categories.forEach(function(cat){
      var pInt=parseInt(cat.amount);
      if (!isNaN(pInt)){
        cat.amount=pInt;
        if(cat.type==1){
          $scope.overallIncome+=pInt;
        }else {
          $scope.overallOutcome+=pInt;
        }
      }else{
        cat.amount=0;
      }
    });
  }

  function showError(text){
    $root.shutter.loading=false;
    $root.shutter.message.isError=true;
    $root.shutter.message.text=text;
    $root.shutter.show=true;
  }
  function showLoading(){
    clearError();
    $root.shutter.loading=true;
  }
  function clearError(){
    $root.shutter.message.isError=false;
    $root.shutter.message.text="";
    $root.shutter.show=false;
  }
  function checkDrawer(){
    recalcOverallAmount();
    if ($scope.overallIncome>0||$scope.overallOutcome>0){
      $root.drawer.show=true;
    }
    else{
      $root.drawer.show=false;
    }
  }
  function genericFailure(error){
    showError(error.message);
    $scope.$apply();
  }

  function loadAppStateSuccess(answer){
    if (answer.result===0){
      if (answer.data.categories!=null){
        $scope.categories=answer.data.categories;
        checkDrawer();
      }
      if (answer.data.contractors!=null){
        $scope.contractors=answer.data.contractors;
      }
    }else{
      showError(answer.data);
    }
    $root.shutter.loading=false;
    $scope.$apply();
  }
  /*----------*/
  $scope.state={stage:'categories'};
  $scope.categories=[];
  $scope.contractors=[];
  $scope.overallIncome=0;
  $scope.overallOutcome=0;
  $scope.operationDate=new Date();

  /*----------*/

  /*----------*/
  this.spendOnCategory=function spendOnCategory(category,amount){
    amount=parseInt(amount);
    if (amount>0){
      category.amount+=amount;
    }
    checkDrawer();
  }

  this.checkOut=function checkOut(){
    recalcOverallAmount();
      if ($scope.overallIncome>0){
          oModalSvc({template:"modal.jade",scope:{contractors:$scope.contractors}}).then(function(result){
              if (result!=null){
                var preparedData=[];
                $scope.categories.forEach(function(cat){
                  if (cat.type==1 && cat.amount>0){
                    preparedData.push({id:cat.id,amount:cat.amount});
                  }
                });
                  showLoading();
                  google.script.run.withFailureHandler(genericFailure).withSuccessHandler(loadAppStateSuccess).checkOut($scope.operationDate.toISOString(),preparedData,result.id);
              }
          });
      }else if($scope.overallOutcome>0){
        var preparedData=[];
        $scope.categories.forEach(function(cat){
          if (cat.type==-1 && cat.amount>0){
            preparedData.push({id:cat.id,amount:cat.amount});
          }
        });
        var avalContractors=$scope.contractors.filter(function(con){return (con.current!=0 && con.type==-1 || con.type==1)});
        if (avalContractors.length>0){
          oModalSvc({template:"modal.jade",scope:{contractors:avalContractors}}).then(function(result){
              if (result!=null){
                showLoading();
                google.script.run.withFailureHandler(genericFailure).withSuccessHandler(loadAppStateSuccess).checkOut($scope.operationDate.toISOString(),preparedData,result.id);
              }
            });
        }else{
          showLoading();
          google.script.run.withFailureHandler(genericFailure).withSuccessHandler(loadAppStateSuccess).checkOut($scope.operationDate.toISOString(),preparedData,null);
        }
      }
      //google.script.run.withSuccessHandler(loadAppStateSuccess).checkOut();

  }

  this.clearCategoryAmount=function clearCategoryAmount(category){
    if (category!=null){
      category.amount=0;
    }else{
      $scope.categories.forEach(function(cat){
        cat.amount=0;
      });
    }
    checkDrawer();
  }

   google.script.run.withFailureHandler(genericFailure).withSuccessHandler(loadAppStateSuccess).loadAppState();

}]);

    </script>
  </body>
</html>